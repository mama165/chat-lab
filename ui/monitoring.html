<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat-Lab Factory Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .node-card {
            @apply bg-white p-5 rounded-xl shadow-sm border border-slate-200 transition-all duration-300;
        }
        /* Effet visuel pour les n≈ìuds "fant√¥mes" (crash√©s ou d√©connect√©s) */
        .node-card.ghost {
            @apply opacity-60 grayscale border-orange-200 bg-slate-50;
        }

        .stat-label { @apply text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1; }
        .stat-value { @apply text-lg font-bold text-slate-700; }

        .progress-track { @apply h-2 rounded-full bg-slate-100 mt-2 overflow-hidden; }
        .progress-fill { @apply h-full transition-all duration-500 ease-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 p-6 min-h-screen">

<div class="max-w-7xl mx-auto">
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
        <div>
            <h1 class="text-3xl font-black tracking-tight text-slate-900 flex items-center gap-3">
                <span class="text-4xl">üè≠</span>
                Chat-Lab <span class="text-blue-600">Factory</span>
            </h1>
            <p class="text-slate-500 text-sm mt-1 font-medium ml-1">Real-time Orchestration & Telemetry</p>
        </div>

        <div class="flex items-center gap-3">
            <div class="px-4 py-2 bg-white rounded-lg shadow-sm border border-slate-200 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                <span class="text-xs font-bold text-slate-500">ACTIVE NODES</span>
                <span id="total-nodes" class="text-lg font-bold text-slate-800 ml-1 font-mono">0</span>
            </div>

            <div id="connection-status" class="px-4 py-2 rounded-lg bg-slate-200 text-slate-500 font-bold text-xs uppercase tracking-widest flex items-center gap-2 transition-colors duration-300">
                <span class="w-2 h-2 rounded-full bg-current"></span>
                CONNECTING...
            </div>
        </div>
    </header>

    <div id="nodes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <div class="col-span-full text-center py-20 text-slate-400 italic">
            Waiting for telemetry data...
        </div>
    </div>
</div>

<script>
    // Configuration
    const API_URL = '/api/monitoring'; // Le Master sert cette route
    const REFRESH_RATE = 1000;         // Rafra√Æchissement en ms

    // --- Utilitaires de formatage ---

    // Convertit les octets en format lisible (MB, GB)
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // Retourne la classe CSS de couleur en fonction du statut
    function getStatusColor(status) {
        switch (status) {
            case 'ALIVE': return 'bg-emerald-500 shadow-emerald-200';
            case 'GHOST': return 'bg-orange-400 shadow-orange-200'; // Perdu de vue > 15s
            case 'DEAD':  return 'bg-red-600 shadow-red-200';
            default:      return 'bg-slate-400';
        }
    }

    // Retourne la couleur de la barre de charge (Backpressure)
    function getLoadColor(percent) {
        if (percent >= 90) return 'bg-red-500';    // Danger / Saturation
        if (percent >= 70) return 'bg-orange-400'; // Warning
        return 'bg-blue-500';                      // Normal
    }

    // --- Rendu HTML d'une carte ---

    function renderNodeCard(node) {
        // Calculs de charge (Queue vs Capacit√©)
        const queue = node.QueueSize || 0;
        const capacity = node.MaxCapacity || 1; // √âvite la division par z√©ro
        const loadPercent = Math.min((queue / capacity) * 100, 100);

        // Classes dynamiques
        const isGhost = node.Status !== 'ALIVE';
        const ghostClass = isGhost ? 'ghost' : '';
        const statusColor = getStatusColor(node.Status);
        const loadBarColor = getLoadColor(loadPercent);
        const pidStatus = node.PIDStatus || 'UNKNOWN';

        // Ic√¥ne selon le type
        let icon = 'üì¶';
        if (node.Type === 'MASTER') icon = 'üß†';
        if (node.Type === 'SCANNER') icon = 'üì°';
        if (node.Type === 'SPECIALIST') icon = 'ü§ñ';

        return `
        <div class="node-card ${ghostClass} hover:-translate-y-1">
            <div class="flex justify-between items-start mb-5 pb-4 border-b border-slate-50">
                <div class="flex items-start gap-3">
                    <div class="text-2xl">${icon}</div>
                    <div>
                        <h3 class="font-bold text-slate-800 text-sm leading-tight">${node.ID}</h3>
                        <div class="text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-wide">${node.Type}</div>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <div class="w-3 h-3 rounded-full ${statusColor} shadow-lg ${!isGhost ? 'animate-pulse' : ''}"></div>
                    <span class="text-[9px] font-bold text-slate-400">PID ${node.PID}</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-50 p-2 rounded border border-slate-100">
                    <div class="stat-label flex justify-between">
                        <span>CPU</span>
                        <span class="text-[9px] ${pidStatus === 'running' || pidStatus === 'RUNNING' ? 'text-green-500' : 'text-orange-400'}">${pidStatus}</span>
                    </div>
                    <div class="stat-value font-mono text-base">${(node.CPU || 0).toFixed(1)}%</div>
                </div>
                <div class="bg-slate-50 p-2 rounded border border-slate-100">
                    <div class="stat-label">Memory</div>
                    <div class="stat-value font-mono text-base">${formatBytes(node.RAM || 0)}</div>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-500">PROCESSED ITEMS</span>
                    <span class="px-2 py-0.5 bg-blue-50 text-blue-700 border border-blue-100 rounded text-xs font-mono font-bold">
                        ${(node.ItemsProcessed || 0).toLocaleString()}
                    </span>
                </div>

                <div>
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Buffer Load</span>
                        <span class="text-[10px] font-mono font-bold text-slate-600">
                            ${queue} <span class="text-slate-300">/</span> ${capacity}
                        </span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill ${loadBarColor}" style="width: ${loadPercent}%"></div>
                    </div>
                </div>
            </div>

            ${node.CurrentItemName ? `
            <div class="mt-4 pt-3 border-t border-slate-50 text-xs text-slate-500 truncate">
                <span class="font-bold text-slate-300 mr-1">DOING:</span> ${node.CurrentItemName}
            </div>` : ''}
        </div>
        `;
    }

    // --- Logique Principale ---

    async function fetchMetrics() {
        const statusBadge = document.getElementById('connection-status');
        const nodesCounter = document.getElementById('total-nodes');
        const grid = document.getElementById('nodes-grid');

        try {
            const response = await fetch(API_URL);

            if (!response.ok) throw new Error("API unreachable");

            const nodesMap = await response.json(); // Map[ID]NodeHealth
            const nodeKeys = Object.keys(nodesMap);

            // Mise √† jour header
            statusBadge.className = "px-4 py-2 rounded-lg bg-emerald-100 text-emerald-700 font-bold text-xs uppercase tracking-widest flex items-center gap-2";
            statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-current animate-pulse"></span> ONLINE';
            nodesCounter.innerText = nodeKeys.length;

            if (nodeKeys.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-20 text-slate-400 italic">No active workers found. Start the Scanner to begin.</div>';
                return;
            }

            // Tri logique : Master -> Scanner -> Sp√©cialistes (alphab√©tique)
            const sortedKeys = nodeKeys.sort((a, b) => {
                const typeA = nodesMap[a].Type;
                const typeB = nodesMap[b].Type;

                if (typeA === 'MASTER') return -1;
                if (typeB === 'MASTER') return 1;
                if (typeA === 'SCANNER') return -1;
                if (typeB === 'SCANNER') return 1;

                return a.localeCompare(b);
            });

            // Injection HTML
            grid.innerHTML = sortedKeys.map(key => renderNodeCard(nodesMap[key])).join('');

        } catch (error) {
            console.error("Monitoring fetch error:", error);

            // Mode "D√©connect√©"
            statusBadge.className = "px-4 py-2 rounded-lg bg-rose-100 text-rose-700 font-bold text-xs uppercase tracking-widest flex items-center gap-2";
            statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-current"></span> DISCONNECTED';
        }
    }

    // D√©marrage de la boucle
    setInterval(fetchMetrics, REFRESH_RATE);

    // Appel initial imm√©diat
    fetchMetrics();

</script>
</body>
</html>