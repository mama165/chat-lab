import sys
import os
import pandas as pd
import m2cgen as m2c
import numpy as np
from sklearn.linear_model import LogisticRegression

# Indispensable pour m2cgen sur des modÃ¨les avec beaucoup de coefficients
sys.setrecursionlimit(10000)

def fnv1a_32(data):
    hash_val = 0x811c9dc5
    for byte in data.encode('utf-8'):
        hash_val ^= byte
        hash_val = (hash_val * 0x01000193) & 0xFFFFFFFF
    return hash_val

def manual_vectorizer(texts, size=1000):
    vectors = []
    for text in texts:
        vec = np.zeros(size)
        t = str(text).lower().replace("!", "").replace("?", "").replace(",", "").replace(".", "")
        words = t.split()
        for w in words:
            idx = fnv1a_32(w) % size
            vec[idx] += 1.0
        vectors.append(vec)
    return np.array(vectors)

def train_and_export():
    current_dir = os.path.dirname(os.path.abspath(__file__))
    csv_path = os.path.join(current_dir, "train.csv")

    if not os.path.exists(csv_path):
        print(f"âŒ Fichier {csv_path} non trouvÃ© !")
        return

    print(f"--- ðŸ“– Lecture de {csv_path} ---")
    # On dÃ©finit df_raw ICI
    df_raw = pd.read_csv(csv_path)

    # Davidson mapping: 0=hate, 1=offensive -> 1 | 2=neither -> 0
    df_raw['label'] = df_raw['class'].apply(lambda x: 1 if x < 2 else 0)

    # --- Injection de tes cas prioritaires (EN + FR) ---
    priority_data = pd.DataFrame([
        {'tweet': "naze", 'label': 1},
        {'tweet': "You are a complete idiot and I hate you", 'label': 1},
        {'tweet': "Shut up you loser", 'label': 1},
        {'tweet': "EspÃ¨ce de gros naze", 'label': 1},
        {'tweet': "Va mourir sale pourriture", 'label': 1},
        {'tweet': "Je ne suis pas d'accord avec toi", 'label': 0},
        {'tweet': "Bonjour tout le monde", 'label': 0}
    ])

    # Gestion de la population de donnÃ©es
    target_sample = 5000
    n_toxic = min(target_sample, len(df_raw[df_raw['label'] == 1]))
    n_healthy = min(target_sample, len(df_raw[df_raw['label'] == 0]))

    print(f"--- âš–ï¸ Ã‰quilibrage : {n_toxic} toxiques / {n_healthy} sains ---")

    df_toxic = df_raw[df_raw['label'] == 1].sample(n=n_toxic, random_state=42)
    df_healthy = df_raw[df_raw['label'] == 0].sample(n=n_healthy, random_state=42)

    # Fusion et mÃ©lange
    df = pd.concat([df_toxic, df_healthy] + [priority_data]*100).sample(frac=1, random_state=42)

    print(f"--- ðŸ§  EntraÃ®nement sur {len(df)} lignes ---")
    X = manual_vectorizer(df['tweet'].values)
    y = df['label'].values

    model = LogisticRegression(solver='lbfgs', max_iter=2000, class_weight='balanced')
    model.fit(X, y)

    print("--- âš™ï¸ Exportation m2cgen ---")
    code = m2c.export_to_go(model, function_name="PredictToxicity")

    output_path = "/app/model.go"
    with open(output_path, "w") as f:
        f.write("// Code generated by ai-gen (Davidson Dataset + Overrides). DO NOT EDIT.\n")
        f.write("package ai\n\n")
        f.write(code)
    print("âœ… model.go gÃ©nÃ©rÃ© avec succÃ¨s.")

if __name__ == "__main__":
    train_and_export()